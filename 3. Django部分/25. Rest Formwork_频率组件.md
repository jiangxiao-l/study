# Rest Formwork_频率组件

## 一、自定义频率控件

```python
class MyThrottle():
    visitor_dic = {}

    def __init__(self):
        self.history = None
        
   // 函数名为：allow_request,view是当前的组件

    def allow_request(self, request, view):
        '''
            {'ip1':[时间1 ,时间2],
            'ip2':[时间1, ],
            }
             （1）取出访问者ip
             
             （2）判断当前ip不在访问字典里，添加进去，并且直接返回True,表示第一次访问，在字典里，继                    续往下走
             
             （3）循环判断当前ip的列表，有值，并且当前时间减去列表的最后一个时间大于60s，把这种数据                     pop掉，这样列表中只有60s以内的访问时间，
             
             （4）判断，当列表小于3，说明一分钟以内访问不足三次，把当前时间插入到列表第一个位置，返                   回True，顺利通过
             
             （5）当大于等于3，说明一分钟内访问超过三次，返回False验证失败
        '''

        # Meta:请求所有的东西的字典
        # 拿出ip地址
        ip = request.META.get('REMOTE_ADDR'）
        
        # 不在字典中,说明是第一次访问
        ctime = time.time()
        if ip not in self.visitor_dic:
            self.visitor_dic[ip] = [ctime, ]
            return True
        
        # 根据当前访问者ip,取出访问的时间列表
        history = self.visitor_dic[ip]
        self.history = history
        while history and ctime - history[-1] > 60:
            history.pop()

        if len(history) < 3:
            # 把当前时间放到第0个位置上
            history.insert(0, ctime)
            return True
        
       //其他的长度大于4
        return False

    def wait(self):
        # 剩余时间
        ctime = time.time()
        return 60 - (ctime - self.history[-1])
```

## 二. drf内置的频率控件

```python
// 1. 在一个py文件中定义一个类，继承一个类

from rest_framework.throttling import BaseThrottle,SimpleRateThrottle

class MyThrottle(SimpleRateThrottle):
    //scope： 在setting文件中对应scope：
    scope='aaa'
    
    def get_cache_key(self, request, view):
        # 返回ip地址
        
        // 方式一：
        # ip=request.META.get('REMOTE_ADDR')
        # return ip
        
        // 方式二：
        return self.get_ident(request)
    
  
// 2. 在setting文件中配置
   REST_FRAMEWORK = {
     #  1. 全局配置，与认证和权限一样的配置
    'DEFAULT_THROTTLE_CLASSES': ['app01.MyAuth.MyThrottle', ],
       
      
    'DEFAULT_THROTTLE_RATES': {
        
        #2.与类中的  scope='aaa'相对应 '10/m' 表示一分钟10次。's','m','h' 秒 分 时
        'aaa': '10/m'
    }
}
   
// 3.在使用类中的使用 ： MyThrottl：为类名

class Test(APIView):
    
    # 1.  局部使用
    throttle_classes = [MyThrottle,]
    
    # 2. 局部禁用，添加一个空的列表
    # throttle_classes = []
 
    def get(self, request):
        print(type(request._request))
        return HttpResponse('ok')
    
   # 3. 错误信息的重写：
    def throttled(self, request, wait):
        
         // 错误信息的重写
        class MyThrottled(exceptions.Throttled):
            default_detail = '傻逼'
            extra_detail_singular = '还剩 {wait} 秒.'
            extra_detail_plural = '还剩 {wait} 秒'
            
        #4. 返回还需要等待的时间数，和错误信息的拼接
        raise MyThrottled(wait)
   
```

