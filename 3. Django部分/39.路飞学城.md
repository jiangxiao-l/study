# 路飞学城

## 一、emement-ui的使用

```
1.下载:npm install element-ui

2.使用:在main.js中配置
	import ElementUI from 'element-ui';
	import 'element-ui/lib/theme-chalk/index.css';
	Vue.use(ElementUI);
```

## 二、专题课程表的介绍

```python
'''
1. course 专题课程表
2. 课程详情表
3. 价格策略表
4. 教师表
'''


from django.db import models
from django.contrib.contenttypes.models import ContentType
from django.contrib.contenttypes.fields import GenericForeignKey

from django.contrib.contenttypes.fields import GenericRelation

class Course(models.Model):
    """专题课程"""
    # unique=True 唯一性约束

    name = models.CharField(max_length=128, unique=True)
    course_img = models.CharField(max_length=255)
    brief = models.TextField(verbose_name="课程概述", max_length=2048)

    level_choices = ((0, '初级'), (1, '中级'), (2, '高级'))
    # 默认值为1 ,中级
    level = models.SmallIntegerField(choices=level_choices, default=1)
    pub_date = models.DateField(verbose_name="发布日期", blank=True, null=True)
    period = models.PositiveIntegerField(verbose_name="建议学习周期(days)", default=7)
    # help_text 在admin中显示的帮助信息
    order = models.IntegerField("课程顺序", help_text="从上一个课程数字往后排")

    status_choices = ((0, '上线'), (1, '下线'), (2, '预上线'))
    status = models.SmallIntegerField(choices=status_choices, default=0)
    # 用于GenericForeignKey反向查询，不会生成表字段，切勿删除
    price_policy = GenericRelation("PricePolicy")

    def __str__(self):
        return self.name

    class Meta:
        verbose_name_plural = "专题课"


class CourseDetail(models.Model):
    """课程详情页内容"""
    course = models.OneToOneField("Course", on_delete=models.CASCADE)
    hours = models.IntegerField("课时")
    # 课程的标语 口号
    course_slogan = models.CharField(max_length=125, blank=True, null=True)
    # video_brief_link = models.CharField(verbose_name='课程介绍', max_length=255, blank=True, null=True)
    # why_study = models.TextField(verbose_name="为什么学习这门课程")
    # what_to_study_brief = models.TextField(verbose_name="我将学到哪些内容")
    # career_improvement = models.TextField(verbose_name="此项目如何有助于我的职业生涯")
    # prerequisite = models.TextField(verbose_name="课程先修要求", max_length=1024)
    # 推荐课程
    # related_name 基于对象的反向查询,用于替换表名小写_set 推荐的课程
    recommend_courses = models.ManyToManyField("Course", related_name="recommend_by", blank=True)
    teachers = models.ManyToManyField("Teacher", verbose_name="课程讲师")

    def __str__(self):
        return "%s" % self.course

    class Meta:
        verbose_name_plural = "课程详细"



class PricePolicy(models.Model):
    """价格与有课程效期表"""
    content_type = models.ForeignKey(ContentType, on_delete=models.CASCADE)  # 关联course or degree_course
    object_id = models.PositiveIntegerField()
    content_object = GenericForeignKey('content_type', 'object_id')


    valid_period_choices = ((1, '1天'), (3, '3天'),
                            (7, '1周'), (14, '2周'),
                            (30, '1个月'),
                            (60, '2个月'),
                            (90, '3个月'),
                            (180, '6个月'), (210, '12个月'),
                            (540, '18个月'), (720, '24个月'),
                            )
    valid_period = models.SmallIntegerField(choices=valid_period_choices)
    price = models.FloatField()
    class Meta:
        unique_together = ("content_type", 'object_id', "valid_period")
        verbose_name_plural = "价格策略"

    def __str__(self):
        return "%s(%s)%s" % (self.content_object, self.get_valid_period_display(), self.price)
    
    

class Teacher(models.Model):
    """讲师、导师表"""
    name = models.CharField(max_length=32)
    image = models.CharField(max_length=128)
    brief = models.TextField(max_length=1024)

    def __str__(self):
        return self.name

    class Meta:

        verbose_name_plural = "讲师"
```

## 三、课程页面的展示 vue

```
1. course.vue 页面

<template>
    <div class="course">
        <el-row>
            <el-col :span="8" v-for="course in courses">
                <el-card :body-style="{ padding: '0px' }">
                    <img :src="course.course_img" class="image">
                    <div style="padding: 14px;">
                        <span>{{ course.name }}</span>
                        <div class="bottom clearfix">
                            <router-link :to="{'name':'coursedeatil','params':{'id':course.id}}">详情</router-link>
                        </div>
                    </div>
                </el-card>
            </el-col>
        </el-row>     
    </div>
</template>


<style>
    .time {
        font-size: 13px;
        color: #999;
    }

    .bottom {
        margin-top: 13px;
        line-height: 12px;
    }

    .button {
        padding: 0;
        float: right;
    }

    .image {
        width: 100%;
        display: block;
    }

    .clearfix:before,
    .clearfix:after {
        display: table;
        content: "";
    }

    .clearfix:after {
        clear: both
    }
</style>


<script>
    export default {
        data: function () {
            return {
                courses: {}
            }
        },
        methods: {
            // 方法 与button相对应
            init: function () {
                let _this = this;
                this.$http.request({
                    url: _this.$url + 'course/',
                    methods: 'get'
                }).then(function (response) {
                    // console.log(response.data.data)
                    _this.courses = response.data.data
                }).catch(function (response) {
                    console.log(response)
                })
            }
        },
        mounted: function () {
            this.init()
        }
    }

</script>



// 重点：   
   
   1. 图片地址的绑定(加‘ ：’)： <img :src="course.course_img" class="image">  
   
   2. id的传送params：
       2.1 <router-link :to="{'name':'coursedeatil','params':                                                     {'id':course.id}}">详情</router-link>
       
       2.2 在router.js 中配置：  path: '/coursedeatil/:id',
      
   3. vue页面挂载时，执行方法：实现数据的加载(就是在页面加载完毕后，就实现数据加载)
              mounted: function () {
                    this.init()
                }
                
  
```

## 四、课程详情的

```html

<template>
  <div class="course">
    <p>书籍的详情页面</p>
      <div>
    <h3>{{ course_detail.course_name}}</h3>
      <h3>{{course_detail.course_slogan}}</h3>
      <p v-for="teacher in course_detail.teachers"><span >
        {{teacher.name}}:{{teacher.brief}}
      </span>
      </p>
      <h2>推荐课程</h2>
        <p v-for="course in course_detail.recommend_courses"><span >
       <router-link :to="{'name':'coursedeatil','params':{'id':course.id}}">{{course.name}}</router-link>

      </span>
      </p>
    </div>
  </div>

</template>


<script>
  export  default {
      data: function () {
          return {
              course_id: this.$route.params.id,
              course_detail: {}
          }
      },
      methods: {
          // 方法 与button相对应
          init: function () {
              let _this = this;
              this.$http.request({
                  url: _this.$url + 'course/' + _this.course_id,
                  methods: 'get'
              }).then(function (response) {
                  // console.log(response.data.data)
                  _this.course_detail= response.data.data
              }).catch(function (response) {
                  console.log(response)
              })
          }
      },
      mounted: function () {
          this.init()
      },
      watch: {
          '$route': function (to,) {
              //修改课程的id
              this.course_id = to.params.id;
              //再去后台加载数据回来
              this.init()
          },

      }
  }

</script>


// 重点：
1. 实现详情页的跳转：
    1.1 ：连接
     <p v-for="course in course_detail.recommend_courses"><span >
       <router-link :to="{'name':'coursedeatil','params':{'id':course.id}}">                                    {{course.name}}</router-link>
         
     2.2 ：判断当前的url发生变化，实现数的加载
         
        watch: {
          '$route': function (to,) {
              //修改课程的id
              this.course_id = to.params.id;
              //再去后台加载数据回来
              this.init()
          },

```

## 五、数据的过滤

```
在后端将数据根据过滤的关键字对数据进行过滤，将过滤的数据传到前端，在前端上进行渲染。
```

## 六、登入(把token保存到浏览器中)

```
1. vuex:状态管理器

	1.1 安装 npm install vuex
	
	1.2 在main.js中配置:
				new Vue({
				  router,
				  store,
				  render: h => h(App)
				})
				
	 1.3 在store中配置：
		       state: {
                     name: '',
                     token: ''
                },
		
		1.4 赋值:
				 this.$store.state.name= _this.name
				 
		1.5 取值:
				this.$store.state.name
			
2. vue-cookies（保存到浏览器的cookie）

     2.1: 在模块中安装：npm install vue-cookies
     
	 2.2 使用:
			2.2.1 导入import Cookie from 'vue-cookies'
			
			2.2.2 取值:Cookie.get('根据key值')
			
			2.2.3 赋值:Cookie.set('key值','value值')
			
	2.3 定义方法:
			定义在:mutations 字典中  第一个参数一定是state
			login:function (state,response) {
				//1. 修改这两个变量的值
				state.name=response.data.name
				state.token=response.data.token
				
			    //2. 往cookie中写数据
				Cookie.set('name',response.data.name)
				Cookie.set('token',response.data.token)
				},
				
	
	-调用方法:
			this.$store.commit('方法名','参数')

```

## 七、购物车功能

### 1. 购物车的添加

```python
from django_redis import get_redis_connection
from rest_framework.exceptions import AuthenticationFailed 
# 登入装饰器
class LoginAuth：
	def authenticate(self,request):
        token = request.GET.get('token')
        ret = models.UserInfo.object.filter(token=token).first()
        if ret:
            return request.user,user
        else:
            raise AuthenticationFailed('用户校验失败，请先登入')


class shoppingCar(APIView):
    #登入认证的装饰器 用rest_formework 组件完成
	authentication_classes=[LoginAuth,]
    #建立连接
    conn = get_redis_connection()
    
    # 一、 加入购物车
    def post(self,request,*args,**kwargs):
        response ={}
        # 1. 取出相应的课程id 和 课程的价格策略id
        course_id = request.data.get('course_id')
        policy_id = request.data.get('policy_id')
        course = models.Course.object.filter(pk=course_id).first()
        if course:
            #2. redies 数据中取数据
            shopping_bytes = self.conn.get('shoppingcar_%s'%request.user.pk)
            if shopping_bytes:
                  shopping_bytes = shopping_bytes.decode('utf-8')
                  shopping_car = json.loads(shopping_bytes)
            else:
                shopping_car={}
               
            # 3.建立该课程的所有的价格策略的字典 policy
            policy={}
            #得到该书籍的所有的价格策略
            policy_price_all= course.price_policy.all()
            for policy_price in policy_price_all:
                policy_one ={
                    'policy_id':policy_price.pk,
                    'peroid':policy_price.get_valid_period_display()
                    'price':policy_price.price     
                }
                policy[str(policy_price.pk)] = policy_one
               
           # 4. 判断价格策略是否是正确的
            if not policy_id in policy:
                response['msg']='没有此课程的价格策略'
                response['status'] =102
             
            #5. 进行数据的更新或者是添加
            if course_id in shopping_car:
                shopping_car[course_id]['default_policy'] = policy_id
                response['msg']='修改成功'
                response['status'] = 100
             else：
                shopping_car[course_id]={
                    'title': course.name,
                    'img': course.course_img,
                    'default_policy': policy_id,
                    'policy': policy
                } 
                 response['msg']='添加成功'
                response['status'] = 100         
        else:
            response['msg']='没有此课程的数据'
            response['status'] =101
        
        return Response(response)
    
   
```

### 2. 购物车的修改

```python
  def put(self, request, *args, **kwargs):
        response = {}
        course_id = request.data.get('course_id')
        policy_id = request.data.get('policy_id')
        course = models.Course.objects.filter(pk=course_id).first()
        if course:
            # 得到该用户在数据库中的购物车的信息
            shopping_bytes = self.conn.get('shoppingcar_%s' % request.user.pk)
            if shopping_bytes:
                # 转为字典格式
                shopping_bytes = shopping_bytes.decode('utf-8')
                shopping_cat = json.loads(shopping_bytes)
            else:
                # 没有的还就空的
                shopping_cat = {}

            # 2.进行判断价格策略
            if not policy_id in shopping_cat[course_id]['policy']:
                response['status'] = 102
                response['msg'] = '没有此课程的价格策略'

            # 3.进行数据的修改和创建
            if course_id in shopping_cat:
                # 修改policy的默认值就可以了
                shopping_cat[course_id]['default_policy'] = policy_id
                response['status'] = 100
                response['msg'] = '修改成功'
             else:
                 response['status'] = 103
                 response['msg'] = '此课程还未添加到购物车中'
            # 保存到数据库中
            self.conn.set('shoppingcar_%s' % request.user.pk, json.dumps(shopping_cat))
        else:
            response['status'] = 101
            response['msg'] = '没有此课程的信息'
            
        return Response(response)
```

### 3. 查看购物车

```python
 def get(self, request, *args, **kwargs):
        response = {}
        # 得到该用户在数据库中的购物车的信息
        shopping_bytes = self.conn.get('shoppingcar_%s' % request.user.pk)
        if shopping_bytes:
            # 转为字典格式
            shopping_bytes = shopping_bytes.decode('utf-8')
            shopping_cat = json.loads(shopping_bytes)
            response['data'] = shopping_cat
            response['status'] = 100
            response['msg'] = '查询成功'
        else:
            response['status'] = 101
            response['msg'] = '购物车空空如也'
            response['data'] = None

        return Response(response)
```

### 4. 购物车的删除

```python
    def delete(self, request, *args, **kwargs):
        response = {}
        course_id = request.data.get('course_id')
        course = models.Course.objects.filter(pk=course_id).first()
        if course:
            # 得到该用户在数据库中的购物车的信息
            shopping_bytes = self.conn.get('shoppingcar_%s' % request.user.pk)
            if shopping_bytes:
                # 转为字典格式
                shopping_bytes = shopping_bytes.decode('utf-8')
                shopping_cat = json.loads(shopping_bytes)
            else:
                response['msg'] = '购物车空空如也'
                response['status'] =102
                return Response(response)

            if course_id not in shopping_cat:
                response['msg'] = "购物车中没有此数据"
                response['status '] = 102
                return Response(response)

            shopping_cat.pop(course_id,None)
            response['status '] = 100
            response['msg'] = '删除成功'
            self.conn.set('shoppingcar_%s' % request.user.pk, json.dumps(shopping_cat))
            return Response(response)
        else:
            response['status'] = 101
            response['msg'] = '没有此课程的信息'
            return Response(response)
```

## 八、支付中心

```python
class payment(APIView):
    
    authentication_classes = [LoginAuth, ]
    conn = get_redis_connection()
    
    def post(self, request, *args, **kwargs):
        response = {}
        # 取出前端传过来的的数据
        # {"course_list": [{"course_id": "1", "policy_id": "1"}, {"course_id": "2",                                "policy_id": "2"}]}
        
        course_list = request.data.get('course_list')
        # 先创建出两个字典
        payment_dic = {}
        global_coupon = {
            'coupon': {},
            'default_coupon': 0
        }
        
        # 2. 拿出购物车
        shoppingcart = self.conn.get('shoppingcar_%s' % request.user.pk)
        # 三元表达式
        shoppingcart_dic = json.loads(shoppingcart) if shoppingcart else {}
        for course_in in course_list:
            # 判断这个id是否在购物车中，如果不在，直接抛出异常
            course_in_id = course_in['course_id']
            if course_in_id not in shoppingcart_dic:
                response['msg'] = '当前课程不存在购物车中'
                response['status'] = 101
            # 定义出一个空的课程详情的字典，内部放了一个空的优惠券
            course_detail = {
                'coupon': {},
                'default_coupon': 0,
            }
            course_detail.update(shoppingcart_dic[course_in_id])
            # 把刚刚的构造的课程详情字典，放到结算中心大字典中
            payment_dic[course_in_id] = course_detail
        # 一次性查询出当前用户的所有的优惠券信息
        import datetime
        ctime = datetime.datetime.now()
        coupon_list = models.CouponRecord.objects.filter(user=request.user,
                                                         status=0,
                                           coupon__valid_end_date__gte=ctime,
                                           coupon__valid_begin_date__lte=ctime
                                                         )
        for coupon in coupon_list:
            # 拿出所有的优惠券的文字描述
            coupon_type = coupon.coupon.coupon_type
            coupon_type_display = coupon.coupon.get_coupon_type_display()
            object_id = coupon.coupon.object_id
            coupon_detail = {
                "coupon_type": coupon_type,
                "coupon_display": coupon_type_display,
            }
            if coupon_type == '0':  # 立减
                coupon_detail['money_equivalent_value'] = coupon.coupon.money_equivalent_value
            elif coupon_type == '1':  # 满减
                coupon_detail['money_equivalent_value'] = coupon.coupon.money_equivalent_value
                coupon_detail['minimum_consume'] = coupon.coupon.minimum_consume
            else:  # 折扣
                coupon_detail['off_percent'] = coupon.coupon.off_percent
                # 全站优惠券
            if not object_id:
                global_coupon['coupon'][str(coupon.pk)] = coupon_detail
            else:
                # 课程优惠券

                if payment_dic.get(str(object_id), None):
                    payment_dic[str(object_id)]['coupon'][str(coupon.pk)] = coupon_detail

        # 存在到数据库中 redis
        self.conn.set('payment_%s' % request.user.pk, json.dumps(payment_dic))
        self.conn.set('globalcoupon_%s' % request.user.pk, json.dumps(global_coupon))
        response['msg'] = '加入成功'
        response['status'] = 100
        return Response(response)
```

## 九、结算中心

```Python
class Account(APIView):
    authentication_classes = [LoginAuth]
    conn = get_redis_connection()

    def post(self, request, *args, **kwargs):
        response = {}

        # 取出前端传过来的数据
        price_in = request.data.get('price')
        bely = request.data.get('bely')
        # 取出结算中心的字典,
        payment_bytes = self.conn.get('payment_%s' % request.user.pk)
        payment_dic = json.loads(payment_bytes) if payment_bytes else {}

        #  全局优惠券大字典
        global_coupon_bytes = self.conn.get('globalcoupon_%s' % request.user.pk)
        global_coupon = json.loads(global_coupon_bytes) if global_coupon_bytes else {}

        # 定义一个列表存储所有课程优惠完成之后的价格,以后计算总价格直接sum(列表)
        list_price = []
        for course_id, course_detail in payment_dic.items():
            # 取出默认价格策略
            default_policy = course_detail['default_policy']
            #取出默认价格
            default_price = course_detail['policy'][str(default_policy)]['price']
            #取出默认优惠券id
            default_coupon_id = course_detail['default_coupon']

            # 如果是0 ,没有选择优惠券,if内的不需要走
            if default_coupon_id != '0':
                default_coupon_detail = course_detail['coupon'][str(default_coupon_id)]
                default_price = self.account(default_price, default_coupon_detail)
            list_price.append(default_price)
        # 计算总价格,也有优惠券
        global_coupon_id = global_coupon['default_coupon']
        global_coupon_detail = global_coupon['coupon'][str(global_coupon_id)]
        final_price = self.account(sum(list_price), global_coupon_detail)

        #     判断贝利是否合法
        if int(bely) > request.user.bely:
            response['msg'] = '贝利数不合法'
            response['status'] = 101
        final_price = final_price - int(bely) / 10
        request.user.bely = request.user.bely - int(bely)
        request.user.save()
        if not final_price == float(price_in):
            response['msg'] = '传入的价格不合法'
            response['status'] = 102
        # 生成订单,往订单表插入一条数据
        if final_price <= 0:
            final_price = 0
        else:
            # 构造支付宝链接
            # 拼凑支付宝url
            alipay = ali()
            import time
            # 生成支付的url
            query_params = alipay.direct_pay(
                subject="路飞学成课程",  # 商品简单描述
                out_trade_no="x2" + str(time.time()),  # 商户订单号
                total_amount=final_price,  # 交易金额(单位: 元 保留俩位小数)
            )
            pay_url = "https://openapi.alipaydev.com/gateway.do?{}".format(query_params)
            response.url = pay_url

        return Response(response)

     # 计算价格的方法
    def account(self, default_price, default_coupon_detail):
        response={}
        coupon_type = default_coupon_detail['coupon_type']
        if coupon_type == 0:  # 立减
            default_price = default_price - default_coupon_detail['money_equivalent_value']
        elif coupon_type == 1:  # 满减
            if default_price >= default_coupon_detail['minimum_consume']:
                default_price = default_price - default_coupon_detail['money_equivalent_value']
            else:
                response['msg'] = '贝利数不合法'
                response['status'] = 101

        else:
            default_price = default_price * default_coupon_detail['off_percent'] / 100

        return default_price
```

