# Django_auth组件

## 一、auth的认识

```
auth的介绍：Django内置的用户认证系统，可以快速的实现，登入，注销，修改密码等功能
```

## 二、auth 的使用

### 1、创建数据库

```python
在组件上添加其他字段的两种方式：

(1) 定义一个表模型,跟User一对一管理
	from django.contrib.auth.models import User
	
	class UserDetail(models.Model):
			phone=models.CharField(max_length=32)
			# 一对一跟auth_user表做关联
			# 如果是从外部引入的表模型,是不能加引号的
			# 如果加引号,只是在当前model找
			user=models.OneToOneField(to=User)
			
			
(2)定义一个表模型,继承(AbstractUser)
	from django.contrib.auth.models import AbstractUser
	
     class UserInfo(AbstractUser):
			phone=models.CharField(max_length=32)
			sex=models.BooleanField()
					

注： 第二种方法还要在setting中配置: AUTH_USER_MODEL ='app01.UserInfo'

	做数据库迁移,以后就没有auth_user这个表了,以后认证组件用的表就是UserInfo
	
	原来auth中的其他操作:-authentication |-login |-logout |-set_password（一样用）	
    
	不一样的地方: 如果之前用到User这个表模型的地方,都换成UserInfo(看后面的操作)

```

### 2. 数据的创建

```python
-from django.contrib.auth.models import User

    # 不能用create
    # user=User.objects.create(username=name,password=pwd)
    # 创建超级用户
    # user=User.objects.create_superuser(username=name,password=pwd)
    # 创建普通用户
    user=User.objects.create_user(username=name,password=pwd)
    
 ---用了第二种方法：
 	 -- from app01.model import *
     
     //注册超级用户：create_superuser
    
 	  UserInfo.objects.create_superuser(username=name, password=pwd, phone=phone,                                               email=email, sex=sex)
 	  
 	  //注册普通用户：create_user
 	  
 	
```

### 3、数据的校验

```python
 from django.contrib import auth
  
 user = auth.authenticate(request, username=name, password=pwd)
 
 // 相当于 user=models.User.objects.filter(name=name,pwd=pwd).first()
 
  // 可以做用户的登入验证
 
```

### 4、登入

```python
 from django.contrib import auth
   auth.login(request,user)


// 其实就是在session中写了一条数据

//  以后再视图类,函数中的request对象中,就有一个user对象,就是当前登录的用户对象

// 如果没有登录,request.user=AnonymousUser,匿名用户
```

### 5、注销

```python
auth.logout(request)

//内部:调用了request.session.flush(),删除了登录状态
```

### 6、登入验证的装饰器

```python
from django.contrib.auth.decorators import login_required

     @login_required(login_url='/login/')
   
	// redirect_field_name:修改?后面的key值,
	
	//  login_url:如果没有登录,跳转到的页面
	
	// 可以局部配置 login_url='/login/'
			
	// 可以全局配置(在setting中): 全局的配置,如果没有登录,跳到这个路由: LOGIN_URL='/login/'
			  
```

### 7、校验密码

```python
request.user.check_password(pwd)

// 先拿到用户(可以是登录用户,可以现查)
```

### 8、修改密码

```python
 user = request.user
 user.set_password(pwd)
 user.save()

// 注意:一定要调用save(),否则是不保存的
```

### 9、通过验证

```
 // 判断是否验证通过
  
  is_authenticated()

// 登入时 返回Ture 就为False
// 一般用在模板上
```

### 10、其他方法

```
  
   is_active:禁止登录网站(用户还存在,封号)

   is_staff:是否对网站有管理权限(能不能登录admin
   
```

### 11. 用户的删除

```
orm的删除
```



## 三、综合的利用

```python
from app01.models import *

from django.contrib import auth

from django.contrib.auth.decorators import login_required


# 注册
def register(request):
    if request.method == 'GET':
        return render(request, 'register.html')
    elif request.method == 'POST':
        name = request.POST.get('name')
        pwd = request.POST.get('pwd')
        phone = request.POST.get('phone')
        sex = request.POST.get('sex')
        email = request.POST.get('email ')
        // 在数据库中创建了数据
        UserInfo.objects.create_superuser(username=name, password=pwd, phone=phone, email=email, sex=sex)
        return HttpResponse('注册成功')

    
    
 #登入
def login(request):
    if request.method == 'GET':
        return render(request, 'login.html')
    elif request.method == 'POST':
        name = request.POST.get('name')
        pwd = request.POST.get('pwd')

        # 做数据的校验
        user = auth.authenticate(request, username=name, password=pwd)
        if user:
            # 登入后将用户信息存储到session中,
            auth.login(request, user)
            
            return  redirect('/index/')
        else:
            return redirect('/index/')
        
       
#注销
def logout(request):
    auth.logout(request)
    return  redirect('/index/')



# 修改密码：
@login_required(login_url='/login/')
def change_pwd(request):
    if request.method == 'GET':
        return  render(request,'change_pwd.html')
    elif request.method == 'POST':
        pwd = request.POST.get("pwd")
        new_pwd = request.POST.get('new_pwd')
        if request.user.check_password(pwd):
            request.user.set_password(new_pwd)
            return HttpResponse(1)
        else:
            return  HttpResponse(2)

```

