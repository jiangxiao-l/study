# Django_中间件

## 一.中间件的认识与作用

```
--认识
	中间件顾名思义，是介于request与response处理之间的一道处理过程，相对比较轻量级，并且在全局上改变django的输入与输出。因为改变的是全局，所以需要谨慎实用，用不好会影响到性能


--作用（可以对全局请求的修改和全局响应的修改）

  1. 如果你想修改请求，例如被传送到view中的HttpRequest对象。 或者你想修改view返回的HttpResponse对   象，这些都可以通过中间件来实现。

  2. 可能你还想在view执行之前做一些操作，这种情况就可以用 middleware来实现。

```

## 二、自定义中间件

```python
from django.utils.deprecation import MiddlewareMixin

-- 先定义个类继承MiddlewareMixin 这个类
class MyMiddleware1(MiddlewareMixin):

	 // 当用户发起请求的时候会依次经过所有的的中间件，这个时候的请求是process_request,
    def process_request(self, request):
        print('MyMiddleware---->1---->process_request')
        
        # return HttpResponse('i am middle--1') 返回HttpRspons对象,直接返回,走自己的                                                        process_response
         return None     # 返回None的时候,继续往下走
         
         
       
      //当views函数处理后，在依次穿过中间件，这个时候是process_response,最后返回给请求者。 
    def process_response(self, request, response):
        print('MyMiddleware--->1---->process_response')
        return response  // 一定要返回一个response的对象。这个对象就是视图函数返回页面的                                     HttpResponse的对象
        
        
      //视图函数层 
      def process_view(self, request, callback, callback_args, callback_kwargs):
             print('MyMiddleware--->1',callback)
             print(callback_args)
             print(callback_kwargs)
             ret = callback(request)
             return ret


    // 视图函数抛出异常时，将异常返回到页面上
     def process_exception(self, request, exception):
         print('middle--1---exception')
         print(exception)
         return HttpResponse(exception)
    
    // 视图函数一定要teturn render()
    def process_template_response(self, request, response):
        print('process_template_response')
        return response

```

## 三、实现过滤器功能的中间件

```python
from django.utils.deprecation import MiddlewareMixin
class MyMiddleware(MiddlewareMixin):
    def process_request(self, request):
        // 当页面发出请求时，得到当前的请求页面，如果是login 或者是根标签，者继续
        if request.path == '/login/' or request.path == '/':
            return None
        else:  
            url = request.get_full_path()
            //判断是否有cookies值
            is_login = request.COOKIES.get('is_login')
            if is_login:
                return
            else:
                return redirect('/login/?next=%s' % url)
```

## 四、实现访问频率的限制的中间件

```python
from django.utils.deprecation import MiddlewareMixin
dic = {}
li = []


class MyMiddleware1(MiddlewareMixin):

    def process_request(self, request):

        import time
        path = request.path

        if not path == '/':

            for k in dic:
                li.append(k)
                # 如果存在path
            if path in li:

                if len(dic[path]) == 3 and (dic[path][2] - dic[path][0] <= 60):

                    return HttpResponse('访问次数过多')
                elif len(dic[path]) == 3 and (dic[path][2] - dic[path][0] > 60):
                    dic.pop(path)
                    return None
                else:
                    # 条件还不成立
                    time = time.time()
                    dic[path].append(time)

                    return None
            else:
                # 如果不存在path
                dic[path] = []
                time = time.time()
                dic[path].append(time)

```

