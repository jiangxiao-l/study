# Django_CSRF

## 一、CSRF的简单介绍

```
 -- 简单介绍
   
    --xss：跨站脚本攻击（可以向服务器提交伪造出来的病毒文件）
 
 	攻击者盗用了你的身份，以你的名义发送恶意请求，对服务器来说这个请求是完全合法的，
 
 -- 具体介绍
   CSRF（Cross-site request forgery）跨站请求伪造，也被称为“One Click Attack”或者Session Riding，通常缩写为CSRF或者XSRF，是一种对网站的恶意利用。尽管听起来像跨站脚本（XSS），但它与XSS非常不同，XSS利用站点内的信任用户，而CSRF则通过伪装来自受信任用户的请求来利用受信任的网站。与XSS攻击相比，CSRF攻击往往不大流行（因此对其进行防范的资源也相当稀少）和难以防范，所以被认为比XSS更具危险性
```

## 二、CSRF原理 以及预防

```
--CSRF原理 

	　 1.登录受信任网站A，并在本地生成Cookie。
　　   2.在不退出A的情况下，访问危险网站B。
　　   3.危险网站B得到了用户的cookie的信息，可以进行此用户的所有功能(比如实现转账功能)


--CSRF的预防
	
	（1）验证 HTTP Referer 字段 查看上一次连接的域名
	（2）在请求地址中添加 token 并验证（加一个随机字符串校验(加载请求的路径里,加载请求体中)）
	（3）在 HTTP 头中自定义属性并验证
		
```

## 三、Django 中的使用

```Python
--  不注释掉中间件的代码 
--- 在模板中添加一个字符串：{% csrf_token %} | { csrf_token }



---前端的代码1：（用form表单传数据）
	<form action="" method="post">
    {% csrf_token %}  // 会在前端熏染一个隐藏掉的inout框，其value值为一段随机的字符串
    <input type="text" name="name">
    <input type="text" name="pwd">
    <input type="submit" value="提交"
</form>

——— 前端的代码2：（用ajax传数据）--> 事先导入jQuery
<script>
    $('#btn').click(function () {
    	// var token = $.cookie('csrftoken') //事先要先导入jQuery.cookie.js 的文件，后面就可                                               以不要在发送csrfmiddlewaretoken随机字符串了，                                                可以直接操作cookie的值
        $.ajax({
            url:"/login/",
            type:'post',
            data:{
               'name': $('[name="name"]').val(),
                'pwd': $('[name="pwd"]').val(),
                'csrfmiddlewaretoken':$('[name="csrfmiddlewaretoken"]').val()
            },  // 将随机字符串传过去
            success:function (data) {
                if (data == 1 ){
                    alert('登入失败')
                }
            }
        })
    })
</script>




---后端的代码：
def login(request):
    if request.method == 'GET':
        return render(request,'login.html')
    elif request.method == 'POST':
    
        next = request.GET.get('next')
        // 得到前端发送过来的数据
        name = request.POST.get('name')
        pwd = request.POST.get('pwd')

        if name == 'jxl' and pwd == '123':

            obj = redirect(next)
            obj.set_cookie('is_login',True)
            return  obj
        else:
            return  HttpResponse("密码错误或账号，登入失败")
        
        
   -- 注：如果往后台传输json的数据时，可以放在头里面
	
```

## 四、CSRF的局部禁用和局部使用

### 1.基于FBV的使用

```python
--局部禁用,全局得使用(没有注释掉)：就是再发送post的请求时，没有携带字符串也能成功
from  django.views.decorators .csrf import csrf_exempt,csrf_protect

	 @csrf_exempt
	 def csrf_disable(request):
		 print(request.POST)
		 return HttpResponse('ok')
    
    
--局部使用,全局得禁用(已经注释掉了)：就是再发送post请求的时候，只有这个函数在没有携带随机字符串的时候，会报错

	@csrf_protect
	def csrf_disable(request):
            print(request.POST)
            return HttpResponse('ok')
```

### 2、基于CBV的使用

```python
只能加在dispatch方法或者类上面
	-局部禁用,全局得使用
	-局部使用,全局得禁用
    
	from  django.views.decorators .csrf import csrf_exempt,csrf_protect
	from django.views import View
	from django.utils.decorators import method_decorator
	
	@method_decorator(csrf_protect,name='dispatch')
	class Csrf_disable(View):
		# @method_decorator(csrf_protect)
		def dispatch(self, request, *args, **kwargs):
			ret=super().dispatch(request, *args, **kwargs)
			return ret
			
		def get(self,request):
			return HttpResponse('ok')

		def post(self,request):
			return HttpResponse('post---ok')
						
```

