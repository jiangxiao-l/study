# django_ajax

## 一、ajax的简介

```
1. 设么是ajax:异步的JavaScript 和 xml(现在基本上用json)
2. ajax有什么用：在前后台做数据交互
3. 之前学的往后台传输数据的方式有：
	- 在浏览器窗口输入地址(get)
	- 在form表单中提交数据(post)
	- ajax 
	
--特点：异步，局部刷新(js的DOM操作)
```

## 二、ajax的基本使用

### 1. 基于ajax简单的数据传输

```
注：实现要先导入jQuery

-----前端部分(template)：
    <from>
        <p>账号： <input type="text" name = 'name' class = 'name'></p>
        <p>密码： <input type="password" name = 'password' class = 'pwd'></p>
        <p><button id = 'btn'>登入</button></p>
         <p  id = 'info'></p>
      </form>
     <script>
            $('#btn').click(function () {
                $.ajax({
                	//指定请求的地址
                	
                    url:{% url 'register' %},
                    // 请求的方式：传输的数据在post里面
                    type: 'post',
                    //在jqueryz中得到input里面的数据，数据层
                    data:{
                        name:$('.name').val(),
                        password :$('.pwd').val()
                    },
                    
                    // data 与前面的data不是同一个数据，而是后端发过来的数据
                    success:function (data) {
                        if (data == '1'){
                           // 重定向到一个页面上
                            location.href= 'https://www.baidu.com'
                        }
                        else {
                          // 利用jQuery 获取标签内的文本内容，并赋值。
                           $('#info').text('登入失败')
                        }
                    }
                })
            })
</script>
      
 ------后端部分(views)
       def register(request):
            if request.method == 'GET':
                return render(request, 'register.html')
            else:
               // 重点部分：
               // 得到通过ajax方式传过来的数据
                name = request.POST.get('name')
                password = request.POST.get('password')
                users = Register.objects.all().filter(name = name   ,password=password).first()
                if users:
                   // 向前台的data传输数据
                    return  HttpResponse(1)
                else:
                    return HttpResponse(2)

 注：携带的数据可以放在url里面 --> GET中取
   --默认的urlencoede编码和formdata，放在data中的数据 ----> POST 
   
   上传的文件不要写绝对路径 ，要写相对路径

```

### 2. 基于ajax实现上传文件(不用json)

```
----前端部分
	注：在上传问文件的时候，form表单里的method 和 enctype 一定要设置
	    上传文件的格式 type：file
	<form action="/files/" method="post" enctype="multipart/form-data">
        <p><input type="file" name="myfile" id="myfile"></p>
        ############################################
        <input type="submit" value="提交">
         //会触发form表单提交数据，所以不行
         #############################################
          <input type="button">  // 可以
   </form>
   <button id="btn">ajax提交文件</button>   // 写在外面也可以
   注： 
   
   js:代码
   <script>
        $("#btn").click(function () {
            //上传文件,必须用FormData
            var formdata=new FormData();     
            //取出文件$("#myfile")[0].files拿到的是文件列表,取第0个把具体的文件取出来
            formdata.append('myfile',$("#myfile")[0].files[0]);
            $.ajax({
                url:'/files_ajax/',
                type:'post',
                
                //不预处理数据,(默认为： name=lqz&age=18)
                 processData:false,
                 
                //指定往后台传数据的编码格式(urlencoded,formdata,json)
                //现在用formdata对象处理了,就不需要指定编码格式了,
                // formdata 已经将编码的问题处理过了
                 contentType:false,
                
                data:formdata,
                success:function (data) {
                   //data的数据类型不一定
                   // 异步，成功返回才能回调
                    alert(data)

                }
           })

        })
</script>


-----后端的代码：

def add_files(request):
    if request.method == 'GET':
        return  render(request,'add_files.html')
    else:
        // 在后端得到从前端传过来的文件的字典
        dic_files = request.FILES
        // 用get --> input 的 name的方式得到，文件的内容
        myfiles = dic_files.get('myfile')
       // 写入文件
        with open(myfiles.name,'wb')as f:
            for line in myfiles:
                f.write(line)

     return  HttpResponse('ok')
   
```

### 3. 基于ajax实现上传文件的功能(利用json)

```
---前端部分
	<from>
        <p>账号： <input type="text" name = 'name' class = 'name'></p>
        <p>密码： <input type="password" name = 'password' class = 'pwd'></p>
        <p><button id = 'btn'>基于json的提交登入</button></p>
        <p  id = 'info'></p>
	</from>
		<button id="btn">ajax提交json格式</button>
	
 --js代码
 <script>
    $('#btn').click(function () {
        var post_data={'name':$(".name").val(),'pwd':$(".pwd").val()};
         // 把post_data这个字典  --> 转成json格式字符串 -- >  JSON.stringify
         //JSON.stringify相当于python中json.dumpus(post_data)
         //pos是个json格式字符串
        var pos=JSON.stringify(post_data);
        $.ajax({
            url:'/json/',
            type:'post',
            data:pos,
            // 请求的编码方式:
            contentType:'application/json',   //默认是（urlencoded）  
            // 响应回来解析的方式
            dataType:'json',
            success:function (data) {
                //如果data是json格式字符串,如何转成对象(字典)? --> JSON.parse(data)
                //data=JSON.parse(data)
                console.log(typeof data)
                console.log(data.status)
                /*
                console.log(data)
                var ret=JSON.parse(data)
                console.log(typeof ret)
                console.log(ret.status)
                */
                //alert(data)

            }
        })

    })
</script>

---- 后端代码：

def add_json(request):
    if request.method=='GET':
        return render(request,'json.html')
    import json
     // 通过json传过来的数据类型为字典将其 序列化为 res是个字典
    res=json.loads(request.body.decode('utf-8'))
    dic={'status':'100','msg':'登录成功'}
    # return HttpResponse('ok')
    # 返回给前台json格式
    # return HttpResponse(json.dumps(dic))   --> 
    return JsonResponse(dic)
    


----------重点:*****
				- 请求的编码方式:
					contentType:'application/json',
				-响应回来解析的方式
					dataType:'json',
					
                 -对象转[字典，列表。。。]换为json的字符转：JSON.stringify(对象) --> dumps
                 -json字符串转换为对象：  JSON.parse(data)    --> loads
                 
                 - contentType:'application/json'：请求的时候，后台的Django程序，一读到是这种                                                    编码格式，就不处理了。
                  									                                                    --  数据放在body体里面：res=json.loads(request.body.decode('utf-8'))
```



### 4.利用装饰器处理前台传过来的json数据

```
--装饰器部分
def outter(func):
    def inner(request,*args, **kwargs):
        request.data = request.POST
        try:
            request.data = json.loads(request.body.decode('utf-8'))
        except Exception as e:
            print(e)
        res = func(request,*args, **kwargs)
        return res

    return inner
    
--函数部分
@outter
def json_files(request):
    if request.method == 'GET':
        return render(request, 'json_files.html')
    elif request.method =="POST":
        print(request.data)
        print(type(request.data))

    return HttpResponse(1)

```

