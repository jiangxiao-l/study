# Django_聚合查询以及其他查询

## 一、聚合查询（aggregate）

```
from django.db.models import Avg, Count, Max, Min, Sum

1 计算所有图书的平均价格
     ret = Book.objects.all().aggregate(Avg('price'))
     print(ret)
   
2 计算图书的最高价格
    ret = Book.objects.all().aggregate(Max('price'))
    print(ret)        

3 计算图书的最高价格,最低价格,平均价格,总价

 ret =Book.objects.all().aggregate(Max('price'),Min('price'),Avg('price'),Sum('price'))
 print(ret)
 
```

## 二、分组查询（annotate）

```
from django.db.models import Avg, Count, Max, Min, Sum

1. 统计每一本书作者个数
     ret=Book.objects.all().annotate(c=Count('authors'))
     print(ret)
     for r in ret:
         print(r.name,'---->',r.c)

     ret = Book.objects.all().annotate(c= Count('authors')).values('name','c')
      print(ret)
        
2. 统计每一个出版社的最便宜的书(以谁group by 就以谁为基表)
    
ret = Publish.objects.all().annotate(m = Min('book__price')).values('name','m')
 print(ret)

3.统计每一本以py开头的书籍的作者个数

    # book --> auithors
    
    ret= Book.objects.filter(name__startswith='py').annotate(c=Count('authors'))
                                                   .values('name',"c")
    print(ret)
    
4  统计每一本以py开头的书籍的作者个数--套用模板
        
 ret=Book.objects.filter(name__startswith='py').annotate(c=Count('authors'))
                                               .values("c")
  print(ret)
        
5  查询各个作者出的书的总价格
        
    ret = Author.objects.all().annotate(s = Sum('book__price')).values('name','s')
    print(ret)

 6  查询名字叫lqz作者书的总价格
 
ret = Author.objects.filter(name='刘清政').annotate(s=Sum('book__price')).values('s')
print(ret)
        
7  查询所有作者写的书的总价格大于30

    ret=Author.objects.all().annotate(s=Sum('book__price')).filter(s__gte=32)
                                                      .values('name','book__name')
     print(ret)
    
8   统计不止一个作者的图书
    ret=Book.objects.all().annotate(c=Count('authors')).filter(c__gt=1)
                                    .values('name','authors__name','c')
    print(ret)

```

## 三、F查询

```
from django.db.models import F

1. 查询评论数大于阅读数的书
        ret=Book.objects.all().filter(commit_num__gt=F('read_num'))
        print(ret)
        
 2. 把所有书的评论数加1
        ret=Book.objects.all().update(commit_num=F('commit_num')+1)
        print(ret)
    
3. 把python这本书的阅读数减5

   ret = Book.objects.all().filter(name='python').update(reat_num=F('reat_num') - 5)
   print(ret)

```

## 四、Q查询

```
from django.db.models import Q

Q函数 为了表示  与& ,  或 | ,   非 ~,


1 .查询作者名字是lqz或者名字是egon的书

  ret=Book.objects.all().filter(Q(authors__name='lqz')|Q(authors__name='egon'))
  print(ret)
        
   没有意义可以用 ','即可
    ret = Book.objects.all().filter(Q(authors__name='lqz') & Q(authors__name='egon'))
    print(ret)
        
2. 查询作者不是lqz的书
        ret=Book.objects.filter(Q(authors__name='lqz'))
        print(ret)
    
3. 构建很复杂的逻辑,需要用括号来区分
  ret = Book.objects.filter((Q(name='红楼梦') & Q(price__gt=100)) | Q(pk__gt=2))
   print(ret)

```

