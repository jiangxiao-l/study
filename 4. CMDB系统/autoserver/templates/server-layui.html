<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>layui</title>
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="stylesheet" href="/static/layui/css/layui.css"  media="all">
</head>
<body>

<form class="layui-form" action="" id="serverModal" style="display: none;">


  <div class="layui-form-item">
    <label class="layui-form-label">选择框</label>
    <div class="layui-input-block">
      <select name="interest">
        <option value=""></option>
        <option value="0">写作</option>
        <option value="1">阅读</option>
        <option value="2">游戏</option>
        <option value="3">音乐</option>
        <option value="4">旅行</option>
      </select>
    </div>
  </div>

  <div class="layui-form-item">
    <div class="layui-input-block">
      <button class="layui-btn" lay-submit="" lay-filter="demo1">立即提交</button>
    </div>
  </div>
</form>

<table class="layui-hide" id="server" lay-filter="server"></table>

<script type="text/html" id="toolbarDemo">
  <div class="layui-btn-container">
    <button class="layui-btn layui-btn-sm" lay-event="getCheckData">删除多个</button>
{#    <button class="layui-btn layui-btn-sm" lay-event="getCheckLength">获取选中数目</button>#}
{#    <button class="layui-btn layui-btn-sm" lay-event="isAll">验证是否全选</button>#}
{#    <button class="layui-btn layui-btn-sm" lay-event="ddddd">删除多个</button>#}
  </div>
</script>

<script type="text/html" id="barDemo">
  <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
  <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
</script>


<script src="/static/jquery-3.3.1.js" charset="utf-8"></script>
<script src="/static/layui/layui.js" charset="utf-8"></script>

<script>
var resdata;
layui.use('table', function(){
  var table = layui.table;

  $.ajax({
      "url": "/backend/get_config/",
      "type": "GET",
      "success": function (data) {
          var resdata = JSON.parse(data);
          resdata.unshift({type: 'checkbox', fixed: 'left'});
          resdata.push({fixed: 'right', title:'操作', toolbar: '#barDemo', width:150});
          var title = '服务器数据表';
          test(resdata, title);
          rowevent(resdata);
      }
  });

  function test(resdata, title) {
      table.render({
          elem: '#server'
          , url: "/backend/ajax_server/"
          , toolbar: '#toolbarDemo'
          , title: title
          {#    ,cols: [[#}
          {#          {type: 'checkbox', fixed: 'left'}, #}
          {#          {field:'id', title:'ID', width:80, fixed: 'left', unresize: true, sort: true},#}
          {#          {field:'username', title:'用户名', width:120, edit: 'text'},#}
          {#          {field:'email', title:'邮箱', width:150, edit: 'text', templet: function(res){#}
          {#                return '<em>'+ res.email +'</em>'#}
          {#          }},#}
          {#          {field:'sex', title:'性别', width:80, edit: 'text', sort: true},#}
          {#          {field:'city', title:'城市', width:100},#}
          {#          {field:'sign', title:'签名'},#}
          {#          {field:'experience', title:'积分', width:80, sort: true},#}
          {#          {field:'ip', title:'IP', width:120},#}
          {#          {field:'logins', title:'登入次数', width:100, sort: true},#}
          {#          {field:'joinTime', title:'加入时间', width:120},#}
          {#          {fixed: 'right', title:'操作', toolbar: '#barDemo', width:150}#}
          {#    ]]#}
          , cols: [resdata]
          , page: true
          , defaultToolbar: ['filter', 'print', 'exports']
      });
  }

  function modify(postdata) {
      $.ajax({
          url : "/backend/modify/",
          type: "POST",
          traditional:true,
          data: postdata,
          success: function(args){
{#              window.location.reload();#}
          }
      })
  }

  //头工具栏事件
  table.on('toolbar(server)', function(obj){
        var checkStatus = table.checkStatus(obj.config.id);
        var ids = [];
        switch(obj.event){
              case 'getCheckData':
                  var data = checkStatus.data;
                  if(data.length == 0){
                        layer.msg('请选择多个！');
                        break;
                  }
                  layer.confirm('真的删除行么', function(index){
                      var data = checkStatus.data;
                      for(var i in data){
                          ids.push(data[i]['id'])
                      }
                      postdata = {"ids":ids, 'action':'del'};
                      console.log(ids);
                      modify(postdata);
                      layer.close(index);
                  });

                  break;

              case 'getCheckLength':
                  var data = checkStatus.data;
                  layer.msg('选中了：'+ data.length + ' 个');
                  break;
              case 'isAll':
                  layer.msg(checkStatus.isAll ? '全选': '未全选');
                  break;
              case 'ddddd':
                  layer.msg(checkStatus);
                  break;
        }
  });

  function rowevent(resdata){
      //监听行工具事件
      table.on('tool(server)', function(obj){
        var data = obj.data;
        //console.log(obj)
        if(obj.event === 'del'){
          layer.confirm('真的删除行么', function(index){
            obj.del();
            console.log(index);
            layer.close(index);
          });
        } else if(obj.event === 'edit'){
            var htmlstr = '';
            console.log(resdata);
            fielddict = {};
            for (var index in resdata){
                if(resdata[index]['field']){
                    fielddict[resdata[index]['field']] = resdata[index]['title']
                }
            }

            console.log(fielddict);

            for(var key in data){

                if(key == 'asset__business_unit__name'){
                    htmlstr += '<div class="layui-form-item">' +
                        '<label class="layui-form-label">'+fielddict[key]+'</label>'+
                        '<div class="layui-input-block">' +
                        '<select name="'+key+'">' +
                                '<option value="">1</option>' +
                                '<option value="">1</option>' +
                                '<option value="">1</option>' +
                                '<option value="">1</option>' +
                                '<option value="">1</option>' +
                        '</select>' +
                        '</div>' +
                      '</div>'
                }else{
                    htmlstr += '<div class="layui-form-item"> ' +
                        '<label class="layui-form-label">' + fielddict[key] + '</label> ' +
                        '<div class="layui-input-block"> <input type="text" name="'+key+'" value='+data[key]+' class="layui-input">' +
                        ' </div> </div>';
                }

            }



            $('#serverModal').append(htmlstr);
            layer.open({
                title: '在线调试'
                ,type: 1
                ,content: $('#serverModal')
                ,area: ['800px', '600px']
                ,offset:['100px']
            });

    {#        layer.prompt({#}
    {#            formType: 3#}
    {#            ,value: data.hostname#}
    {#        }, function(value, index){#}
    {##}
    {#            obj.update({#}
    {#                hostname: value#}
    {#            });#}
    {#            layer.close(index);#}
    {#      });#}
            console.log(data);

        }
      });
  }
  //监听单元格编辑
  table.on('edit(server)', function(obj){
      console.log(obj);
    var value = obj.value //得到修改后的值
    ,data = obj.data //得到所在行所有键值
    ,field = obj.field; //得到字段
    layer.msg('[ID: '+ data.id +'] ' + field + ' 字段更改为：'+ value);
  });

});
</script>

</body>
</html>