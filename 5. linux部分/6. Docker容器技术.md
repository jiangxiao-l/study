#  Docker容器技术

## 1. 环境的准备：

```python
 curl  http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -o /etc/yum.repos.d/docker-ce.repo

wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo

curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo

yum install -y yum-utils device-mapper-persistent-data lvm2

yum list docker-ce.x86_64 --showduplicates | sort -r

yum install -y --setopt=obsoletes=0 \
docker-ce-17.03.2.ce-1.el7.centos.x86_64 \
docker-ce-selinux-17.03.2.ce-1.el7.centos.noarch

systemctl daemon-reload

systemctl restart docker

docker version

docker  info



```

## 2. 配置镜像加速

```python
https://cr.console.aliyun.com/cn-hangzhou/mirrors

 mkdir -p /etc/docker

tee /etc/docker/daemon.json <<-'EOF'
{
   "registry-mirrors": ["https://68rmyzg7.mirror.aliyuncs.com"]
}
EOF	  

或者：
 vim   /etc/docker/daemon.json

	{
		 "registry-mirrors": ["https://68rmyzg7.mirror.aliyuncs.com"]
	}
```

## 3. pull镜像

```python
docker pull  centos:6.9
docker pull  centos:7.5.1804
docker pull  nginx
```

## 4. docker的介绍

```
1.开启:docker： systemctl start docker

2.开机自启docker：systemctl enable docker

3. docker的三大要点：镜像(image)，容器(conter), 镜像仓库
 
```

## 5.docker 的基础使用

```
1.查询镜像
	docker images
	docker images -q 
	docker inspect ID/name:tag

2. 删除镜像
	docker rmi  ID 
	docker rmi `docker images -q` 删除所有的镜
	
3. 启动容器并获取镜像
	[root@docker ~]# docker  run -d -p 80:80 httpd  --> 可以在浏览器上看到
	[root@docker ~]# docker ps -a  --> 查看
    [root@docker ~]# docker images
 
 4. 导入导出镜像
	[root@docker ~]# docker image save nginx >/opt/nginx.tar.gz
	[root@docker ~]# docker image load -i /opt/nginx.tar.gz

 5. 启动：docker run -it --name "test" centos:6.9
 
```

## 6.自定义一个镜像

```

		第一个镜像创建:
		docker ps -a 
		docker commit xxxxxx oldguo/wordpress:v1
		docker images 
	
		第二个镜像创建:
		docker run -it -p 180:80 --name="wordpress1" ae74026f73e5  /bin/bash
		cd /usr/local/apache2/htdocs
		echo "<html><body><h1>Hi,Oldguo</h1></body></html>" >index.html
		exit 
		docker commit wordpress1 oldguo/wordpress:v2
	    docker rm -f `docker ps -qa`
		docker run -it --name="test" 0ae9bcda8b8b /bin/bash
	
```

## 7.yum 源的优化及安装必要的软件

```
一.优化:
 mv /etc/yum.repos.d/*.repo /tmp

 echo -e "[ftp]\nname=ftp\nbaseurl=ftp://10.0.0.100/pub/centos7\ngpgcheck=0">/etc/yum.repos.d/ftp.repo

二：安装：
 1. yum install -y vim net-tools  iproute  -y
 2. yum install -y openssh-*
 
三.在centos7下面的ssh的前期配置：
     1. yum install -y sed 
     mkdir /var/run/sshd
     echo 'UseDNS no' >> /etc/ssh/sshd_config
     sed -i -e '/pam_loginuid.so/d' /etc/pam.d/sshd
     echo 'root:123456' | chpasswd
     /usr/bin/ssh-keygen -A
     
     
     2. /usr/sbin/sshd -D 
 
     3. ctrl p  q ：退出
     
```

## 8.自定义镜像的最终版

```python
docker  images

1.启动新容器
docker run -it --name "centos7.5" 76d6bc25b8a5

2.优化yum源
mv /etc/yum.repos.d/*.repo /tmp

echo -e "[ftp]\nname=ftp\nbaseurl=ftp://10.0.0.100/pub/centos7\ngpgcheck=0">/etc/yum.repos.d/ftp.repo


3. 安装必须软件包：
yum install -y vim net-tools  iproute   openssh-*  -y

4.启动SSHD

 mkdir /var/run/sshd
 
 echo 'UseDNS no' >> /etc/ssh/sshd_config
 sed -i -e '/pam_loginuid.so/d' /etc/pam.d/sshd
 echo 'root:123456' | chpasswd
 /usr/bin/ssh-keygen -A
 
 /usr/sbin/sshd -D 
 
 ctrl p  q 
  
 注意: 以上操作做完之后,会一直不退出,需要用以下命令退回到宿主机,并不关闭容器：ctrl p  q
 
 5.制作镜像
docker commit centos7.5 oldguo/centos7_sshd:v2


6. 查看：docker images;
```

## 9.使用dockerfile创建镜像

```python 

1. cd  /opt
  mkdir dockerfile

2. ## Centos7.5：基于centos7.5的使用

vim  dockerfile 
FROM centos:7.5.1804
RUN mv /etc/yum.repos.d/*.repo /tmp
RUN echo -e "[ftp]\nname=ftp\nbaseurl=ftp://10.0.0.100/pub/centos7\ngpgcheck=0">/etc/yum.repos.d/ftp.repo
RUN yum install -y openssh-server
RUN yum install -y openssh-clients
RUN yum install net-tools* -y
RUN yum install iproute-* -y
RUN mkdir /var/run/sshd
RUN echo 'UseDNS no' >> /etc/ssh/sshd_config
RUN sed -i -e '/pam_loginuid.so/d' /etc/pam.d/sshd
RUN echo 'root:123456' | chpasswd
RUN /usr/bin/ssh-keygen -A
EXPOSE 22
CMD ["/usr/sbin/sshd", "-D"]


2. 使用：
docker build -t "oldguo/centos7_sshd:v3" /opt/dockerfile
```

## 10.容器的管理

```python 
1.容器的类
   1.1 工具类:vim 直接进入shell窗口，退出就直接退出了
docker run -it --name="test_vim"   3fe2fe0dab2e /bin/bash

  1.2 服务类:nginx :放到后台运行，需要将端口映射到 本地的端口      
docker run -d -p 8080:80 --name="discuz" nginx:1.14
  
2 容器的常用管理命令
	docker ps -a（可以看到容器的运行情况）-q -l
	
	docker rm 容器ID|容器名称
    
	批量删除已关闭
	docker rm -v $(docker ps -aq -f status=exited)
	批量强制删除所有
	docker rm -f `docker ps -a –q`
    
    docker stop: 比较慢
    docker kill：快
    docker restart:重启

```

